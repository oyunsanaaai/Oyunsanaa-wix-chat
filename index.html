<script>
(function(){
  // ====== DOM refs ======
  const modal   = document.querySelector('.oy-modal');
  const overlay = document.querySelector('.oy-overlay');
  const drawer  = document.querySelector('.oy-drawer');
  const btnDrawer = document.getElementById('btnDrawer'); // байхгүй бол OK
  const btnClose  = document.getElementById('btnClose');  // байхгүй бол OK
  const fab     = document.querySelector('.oy-fab');      // байхгүй бол OK
  const textarea = document.querySelector('.oy-textarea'); // Composer textarea (байхгүй бол алгасна)
  const sendBtn  = document.querySelector('.oy-send');     // Send button (байхгүй бол алгасна)
  const iframe   = document.getElementById('oy-frame') || document.querySelector('.oy-modal iframe');

  // ====== State ======
  let lastActive = null;
  const qs = new URLSearchParams(location.search);
  const IS_EMBED = qs.get('embed') === '1';
  const AUTO_OPEN = qs.get('open') === '1';

  // ====== Utils ======
  function isMobile(){ return window.innerWidth <= 520; }

  function lockScroll(lock){
    if (lock) {
      document.body.dataset._prevOverflow = document.body.style.overflow || '';
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = document.body.dataset._prevOverflow || '';
      delete document.body.dataset._prevOverflow;
    }
  }

  function fitModalHeight(){
    if (!modal) return;
    if (isMobile()){
      // iOS/Android keyboard-тай үед өндөр доголохыг багасгана
      modal.style.height = window.innerHeight + 'px';
    } else {
      modal.style.height = ''; // CSS-дээ даатгана (80–86vh)
    }
  }

  function focusFirst(el){
    if (!el) return;
    const focusables = el.querySelectorAll('button, [href], input, textarea, select, [tabindex]:not([tabindex="-1"])');
    if (focusables.length) focusables[0].focus();
  }

  // ====== Open / Close ======
  window.OY_OPEN = function(){
    if (!modal) return;
    lastActive = document.activeElement;
    modal.hidden = false;
    lockScroll(true);
    fitModalHeight();
    focusFirst(modal);
  };

  window.OY_CLOSE = function(){
    if (!modal) return;
    modal.hidden = true;
    lockScroll(false);
    if (lastActive && typeof lastActive.focus === 'function') {
      try{ lastActive.focus(); }catch(e){}
    }
  };

  // Overlay click → close
  if (overlay){
    overlay.addEventListener('click', () => OY_CLOSE());
  }

  // Drawer toggle
  if (btnDrawer && drawer){
    btnDrawer.addEventListener('click', () => {
      drawer.classList.toggle('open');
    });
  }
  if (btnClose){
    btnClose.addEventListener('click', () => OY_CLOSE());
  }

  // Esc → close
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal && !modal.hidden) {
      OY_CLOSE();
    }
  });

  // Resize / orientation
  window.addEventListener('resize', fitModalHeight);
  window.addEventListener('orientationchange', fitModalHeight);

  // URL flags
  if (IS_EMBED){
    // Эмбед үед дотоод header/bubble-ийг нуух шаардлагатай бол root атрибут тавьж өгье
    document.documentElement.setAttribute('data-embed', '1');
    if (fab) fab.style.display = 'none';
  }
  if (AUTO_OPEN){
    // Хуудас ачаалмагц автоматаар нээнэ
    requestAnimationFrame(() => OY_OPEN());
  }

  // ====== Composer (optional) ======
  function updateSendState(){
    if (!textarea || !sendBtn) return;
    const val = (textarea.value || '').trim();
    sendBtn.disabled = val.length === 0;
  }

  function autosize(e){
    if (!textarea) return;
    textarea.style.height = 'auto';
    // max-height CSS-д байгаа: 120px — хэрэглэнэ
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
  }

  if (textarea){
    textarea.addEventListener('input', () => { autosize(); updateSendState(); });
    textarea.addEventListener('focus', () => { autosize(); });
    // Enter → илгээх, Shift+Enter → шинэ мөр
    textarea.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey){
        if (sendBtn && !sendBtn.disabled){
          e.preventDefault();
          sendBtn.click();
        }
      }
    });
    // Анхны төлөв
    autosize();
    updateSendState();
  }

  if (sendBtn){
    sendBtn.addEventListener('click', () => {
      // Энд өөрийн илгээх логикоороо солих
      // Жишээ: window.postMessage(...) эсвэл өөр handler
      // Илгээсний дараа textarea-г цэвэрлэж, хэмжээ/төлвийг шинэчилнэ
      if (!textarea) return;
      const msg = textarea.value.trim();
      if (!msg) return;
      // TODO: send(msg)
      textarea.value = '';
      autosize();
      updateSendState();
      textarea.focus();
    });
  }

  // ====== iframe ↔ parent харилцах (сонголттой) ======
  // Чат iframe дотроос window.parent.postMessage('oy:close', '*') гэж дуудах боломж.
  window.addEventListener('message', (evt) => {
    try{
      if (evt.data === 'oy:close') OY_CLOSE();
      if (typeof evt.data === 'object' && evt.data.type === 'oy:open') OY_OPEN();
    }catch(e){}
  });

  // Аюулгүй байдлын жижиг сайжруулалт: iframe sandbox/allow аттрибут шалгая
  if (iframe){
    const allow = iframe.getAttribute('allow') || '';
    const need = ['clipboard-write','microphone','camera'];
    need.forEach(flag => {
      if (!allow.includes(flag)){
        iframe.setAttribute('allow', (allow ? allow + '; ' : '') + flag);
      }
    });
    // referrerpolicy байхгүй бол нэмье
    if (!iframe.getAttribute('referrerpolicy')){
      iframe.setAttribute('referrerpolicy','no-referrer');
    }
    // lazy биш — чат тул eager байж болно
    if (!iframe.getAttribute('loading')){
      iframe.setAttribute('loading','eager');
    }
  }
})();
</script>
